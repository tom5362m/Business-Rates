---
title: "Reconstitution Code"
author: "Marshall"
date: "2024-06-12"
output: html_document
---

```{r dependecies}
#| include: true
#| warning: false
#| message: false
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(knitr)
library(readxl)# For importing from excel spreadsheets
library(visNetwork)#netwroking interactive graph package


```

## R Markdown


```{r import and cleaning, include=FALSE}
raw_data <- read_excel("C:/Users/thoma/OneDrive/Documents/Goodman Nash/Business-Rates/Data/AK8038429000.xlsx")
raw_data<-read_excel("Data/AK8038429000.xlsx")
raw_data <-raw_data%>%
  rename(AK="Addresskey",
         List="List Year",
         Effective="Effective Date",
         Alteration="List Alteration Date",
         Assessment="Ass Ref",
         Case="Case Number")

```

## Including Plots

You can also embed plots, for example:

```{r creating the tables, echo=FALSE}

nodes <- raw_data$AK%>%
  unique()%>%
  as.data.frame()

colnames(nodes)<-"id"

child_data<- raw_data%>%
  filter(raw_data$Relationship=="Child")

parent_data<- raw_data%>%
  filter(raw_data$Relationship=="Parent")

parent_data<-parent_data%>%
  mutate(Effective = if_else(is.na(Effective), as.Date("1995/04/01"), Effective))

parent_data<-parent_data%>%
  mutate(RV = if_else(is.na(RV), 0, RV))

child_data<-child_data%>%
  mutate(rv = if_else(is.na(RV), 0, RV))

child_data<-child_data%>%
  mutate(RV = if_else(is.na(Effective), as.Date("1995/04/01"), Effective))


cases<-raw_data%>%
  group_by(Case)%>%
  group_by(Relationship)

cases<-cases%>%
  mutate(RV = if_else(is.na(RV), 0, RV))

cases<-cases%>%
  mutate(Effective = if_else(is.na(Effective), as.Date("1995/04/01"), Effective))

cases$from<-0

cases$to<-0

cases <- cases%>%
  mutate(to=ifelse(Relationship=="Child",cases$AK, cases$to))

cases <- cases%>%
  mutate(from=ifelse(Relationship=="Parent",cases$AK, cases$from))

cases$Relationship[cases$Relationship=="Child"]<-1
cases$Relationship[cases$Relationship=="Parent"]<-0
cases$Relationship<-ifelse(is.na(cases$Relationship),2,cases$Relationship)

cases$Relationship <- as.numeric(cases$Relationship)

parent_values <- cases%>%
  filter(Relationship==0)%>%
  select(AK,Case,Relationship)

child_values <- cases%>%
  filter(Relationship==1)%>%
  select(AK,Case,Relationship)

final_cases_parent<-left_join(cases,parent_values,by="AK")
final_cases_child<-left_join(cases,child_values,by="AK")

final_cases_together<-rbind(final_cases_child,final_cases_parent)

final_cases<-c("from","to")

final_cases<-as.data.frame(final_cases)

names(final_cases_together)[names(final_cases_together) == 'Relationship.x'] <- 'Relationship'

names(final_cases_together)[names(final_cases_together) == 'Case.y'] <- 'node'

final_cases<-final_cases_together%>%
  filter(Relationship!=2)%>%
  mutate(to=ifelse(from==0&to!=0&Relationship==1,node,from),
         from=ifelse(to==0&from!=0&Relationship==0,node,to))

link_data<-data.frame(final_cases$from,final_cases$to)

colnames(link_data)<-c("from","to")

link_data<-link_data%>%
  filter(from!=0)%>%
  filter(to!=0)

link_data<-link_data%>%
  distinct()

network_graph<-visNetwork(nodes,link_data,physics=FALSE)%>%
  visNodes()

visSave(network_graph,"Interactive graph.html")

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
