---
title: "Reconstitution Code"
author: "Marshall"
date: "2024-06-12"
output: html_document
---

```{r dependecies}
#| include: true
#| warning: false
#| message: false
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(knitr)
library(readxl)# For importing from excel spreadsheets
library(visNetwork)#netwroking interactive graph package
library(lubridate)

```

## R Markdown


```{r import and cleaning, include=FALSE}
raw_data <- read_excel("C:/Users/thoma/OneDrive/Documents/Goodman Nash/Business-Rates/Data/AK8038429000.xlsx")
raw_data<-read_excel("Data/AK8038429000.xlsx")
raw_data<-read_excel("Data/AK10059370000.xlsx")
raw_data<-read_excel("Data/Raven Suite - AK - 13091186000.xlsx")

raw_data_1<-read_excel("Data/Part 1 AK11002881000.xlsx")
raw_data_2<-read_excel("Data/Part 2 AK11002881000.xlsx")

raw_data<-rbind(raw_data_1,raw_data_2)

raw_data <-raw_data%>%
  rename(AK="Addresskey",
         List="List Year",
         Effective="Effective Date",
         Alteration="List Alteration Date",
         Assessment="Ass Ref",
         Case="Case Number")

```

## Including Plots

You can also embed plots, for example:

```{r creating the tables, echo=TRUE}

new_nodes<-raw_data%>%
  select(AK,Effective,RV)

new_nodes<-new_nodes%>%
  mutate(Effective=if_else(is.na(Effective), as.Date("1995/04/01"), Effective),
         RV=if_else(is.na(RV), 0, RV))

new_nodes<-new_nodes%>%
  mutate(str_replace_all(Effective,"-","/"))

colnames(new_nodes)<-c("AK","Effective","RV","effective_date")

new_nodes<-new_nodes%>%
  group_by(AK)%>%
  slice(which.max(as_date(effective_date)))

nodes<-new_nodes%>%
  ungroup()%>%
  mutate(group=if_else(RV>0&RV<12000,"full sbr",
                                 if_else(RV>=12000&RV<15000,"partial sbr",
                                         if_else(RV==0,"zero","inelligible"))))

names(nodes)[names(nodes)=="AK"]<-"id"

child_data<- raw_data%>%
  filter(raw_data$Relationship=="Child")

parent_data<- raw_data%>%
  filter(raw_data$Relationship=="Parent")

parent_data<-parent_data%>%
  mutate(Effective = if_else(is.na(Effective), as.Date("1995/04/01"), Effective))

parent_data<-parent_data%>%
  mutate(RV = if_else(is.na(RV), 0, RV))

child_data<-child_data%>%
  mutate(rv = if_else(is.na(RV), 0, RV))

child_data<-child_data%>%
  mutate(RV = if_else(is.na(Effective), as.Date("1995/04/01"), Effective))


cases<-raw_data%>%
  group_by(Case)%>%
  group_by(Relationship)

cases<-cases%>%
  mutate(RV = if_else(is.na(RV), 0, RV))

cases<-cases%>%
  mutate(Effective = if_else(is.na(Effective), as.Date("1995/04/01"), Effective))

cases$from<-0

cases$to<-0

cases <- cases%>%
  mutate(to=ifelse(Relationship=="Child",cases$AK, cases$to))

cases <- cases%>%
  mutate(from=ifelse(Relationship=="Parent",cases$AK, cases$from))

parent_values <- cases%>%
  filter(Relationship=="Parent")%>%
  select(AK,Case,Relationship)

child_values <- cases%>%
  filter(Relationship=="Child")%>%
  select(AK,Case,Relationship)

final_cases_parent<-left_join(cases,parent_values,by="Case")
final_cases_child<-left_join(cases,child_values,by="Case")

final_cases_together<-rbind(final_cases_child,final_cases_parent)

final_cases<-c("from","to")

final_cases<-as.data.frame(final_cases)

names(final_cases_together)[names(final_cases_together) == 'Relationship.x'] <- 'Relationship'

names(final_cases_together)[names(final_cases_together) == 'Case.y'] <- 'node'

final_cases<-final_cases_together%>%
  filter(Relationship!=is.na(final_cases_together$Relationship))%>%
  mutate(to=ifelse(Relationship=="Parent" & Relationship.y=="Child"&from!=0&to==0,AK.y,to))

address_change_data <- raw_data%>%
  filter(`Change Reason`=="ADDRESS CHANGE & REVIEW OF ASSESSMENT")

address_change_data<-address_change_data%>%
  mutate(RV = if_else(is.na(RV), 0, RV))

address_change_data<-address_change_data%>%
  mutate(from=if_else(RV==0,AK,0),
         to=if_else(RV!=0,AK,0))

address_from_data<-address_change_data%>%
  sort_by(address_change_data$Case)%>%
  filter(from!=0)

address_to_data<-address_change_data%>%
  sort_by(address_change_data$Case)%>%
  filter(to!=0)

address_link_data<-data.frame(address_from_data$from,address_to_data$to)

colnames(address_link_data)<-c("from","to")

address_link_data<-address_link_data%>%
  distinct()

address_link_data<-address_link_data%>%
  mutate(color="purple")

```



```{r creating the plots, echo=TRUE}

link_data<-data.frame(final_cases$from,final_cases$to)

colnames(link_data)<-c("from","to")

link_data<-link_data%>%
  filter(from!=0)%>%
  filter(to!=0)

link_data<-link_data%>%
  mutate(color="pink")

link_data<-link%>%
  distinct()

link_data_all<-rbind(link_data,address_link_data)

ledges<-data.frame(color=c("pink","purple"),
                   label=c("Reconstitution","ADDRESS CHANGE & REVIEW OF ASSESSMENT"),
                   width=5)

network_graph<-visNetwork(nodes,link_data_all,physics=FALSE,width="100%")%>%
  visNodes()%>%
  visEdges(arrows = "middle",width = 5)%>%
  visGroups(groupname = "zero", color="lightblue")%>%
  visGroups(groupname = "full sbr", color="lightgreen")%>%
  visGroups(groupname = "partial sbr", color="orange")%>%
  visGroups(groupname = "inelligible", color="red")%>%
  visOptions(nodesIdSelection = TRUE,highlightNearest = TRUE)%>%
  visLegend(addEdges = ledges,
            addNodes=list(font.color = "white"))

visSave(network_graph,"Interactive graph.html")

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
